# RKE2 / K3s plugins for rk9s
# Node scope: $NAME is the node name
# Requires: ssh access or kubectl debug
plugins:
  rke2-k3s-config:
    shortCut: Shift-C
    description: View RKE2/K3s config on node
    scopes:
      - node
      - nodes
    command: bash
    background: false
    args:
      - -c
      - |
        echo "=== Node config: $NAME ==="
        kubectl debug node/$NAME --context $CONTEXT -it --image=alpine:3.18 -- chroot /host sh -c '
          if [ -f /etc/rancher/rke2/config.yaml ]; then
            echo "--- /etc/rancher/rke2/config.yaml ---"
            cat /etc/rancher/rke2/config.yaml
          elif [ -f /etc/rancher/k3s/config.yaml ]; then
            echo "--- /etc/rancher/k3s/config.yaml ---"
            cat /etc/rancher/k3s/config.yaml
          else
            echo "No RKE2 or K3s config found"
          fi
        ' 2>/dev/null | less -K
  node-distro-services:
    shortCut: Shift-D
    description: Node services (rke2/k3s/containerd)
    scopes:
      - node
      - nodes
    command: bash
    background: false
    args:
      - -c
      - |
        kubectl debug node/$NAME --context $CONTEXT -it --image=alpine:3.18 -- chroot /host sh -c 'systemctl status rke2-server rke2-agent k3s containerd kubelet 2>/dev/null || true' 2>/dev/null | less -K || echo "Run: ssh $NAME 'systemctl status rke2-server rke2-agent k3s containerd kubelet'"
  crictl-ps:
    shortCut: Shift-P
    description: crictl ps on node
    scopes:
      - node
      - nodes
    command: bash
    background: false
    args:
      - -c
      - |
        kubectl debug node/$NAME --context $CONTEXT -it --image=rancher/mirrored-pause:3.6 --target=containerd -- chroot /host crictl ps 2>/dev/null | less -K
  etcdctl-health:
    shortCut: Shift-E
    description: etcdctl endpoint health
    scopes:
      - node
      - nodes
    command: bash
    background: false
    args:
      - -c
      - |
        kubectl debug node/$NAME --context $CONTEXT -it --image=rancher/mirrored-coreos-etcd:v3.5.9 --target=etcd -- sh -c 'ETCDCTL_ENDPOINTS=https://127.0.0.1:2379 ETCDCTL_CACERT=/etc/kubernetes/pki/etcd/ca.crt ETCDCTL_CERT=/etc/kubernetes/pki/etcd/server.crt ETCDCTL_KEY=/etc/kubernetes/pki/etcd/server.key etcdctl endpoint health' 2>/dev/null | less -K
