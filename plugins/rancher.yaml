# Rancher plugins for rk9s
# Uses rancher CLI + kubectl against management CRDs
# Navigation: Use Shift-6 for Rancher Clusters, Shift-7 for Projects
# Scoped to Rancher/Fleet management CRDs; override=true needed because
# Shift keys collide with base table sort bindings on every table view
plugins:
  rancher-cluster-overview:
    shortCut: Shift-O
    override: true
    description: Cluster overview (nodes, versions, conditions)
    scopes:
      - clusters.management.cattle.io
    command: bash
    background: false
    args:
      - -c
      - |
        echo "=== Rancher Managed Cluster: $NAME ==="
        echo ""
        echo "--- Cluster Info ---"
        kubectl get clusters.management.cattle.io $NAME -o jsonpath='{
          "Display Name: "}{.spec.displayName}{"
          "}{  "Provider:     "}{.status.provider}{"
          "}{  "K8s Version:  "}{.status.version.gitVersion}{"
          "}{  "State:        "}{.status.conditions[?(@.type=="Ready")].status}{"
          "}{  "Agent Image:  "}{.status.agentImage}{"
          "}' --context $CONTEXT 2>/dev/null
        echo ""
        echo "--- Conditions ---"
        kubectl get clusters.management.cattle.io $NAME -o jsonpath='{range .status.conditions[*]}  {.type}: {.status} ({.reason}) {.message}{"\n"}{end}' --context $CONTEXT 2>/dev/null
        echo ""
        echo "--- Nodes (via management API) ---"
        kubectl get nodes.management.cattle.io -l management.cattle.io/cluster-name=$NAME -o wide --context $CONTEXT 2>/dev/null
        echo "" | less -K
  rancher-cluster-list:
    shortCut: Shift-U
    override: true
    description: All clusters (rancher CLI or kubectl)
    scopes:
      - clusters.management.cattle.io
      - contexts
    command: bash
    background: false
    args:
      - -c
      - |
        echo "=== Rancher Managed Clusters ==="
        echo ""
        if command -v rancher >/dev/null 2>&1; then
          rancher cluster ls 2>/dev/null | less -K
        else
          kubectl get clusters.management.cattle.io --context $CONTEXT -o custom-columns='NAME:.metadata.name,DISPLAY:.spec.displayName,PROVIDER:.status.provider,K8S:.status.version.gitVersion,READY:.status.conditions[?(@.type=="Ready")].status,NODES:.status.allocatable.pods' 2>/dev/null | less -K
        fi
  rancher-sync-kubeconfig:
    shortCut: Shift-K
    override: true
    description: Generate kubeconfig for cluster
    scopes:
      - clusters.management.cattle.io
      - contexts
    command: bash
    background: false
    args:
      - -c
      - |
        if command -v rancher >/dev/null 2>&1; then
          rancher cluster kf $NAME 2>/dev/null | less -K
        else
          echo "Generating kubeconfig from Rancher API..."
          kubectl get secret -n cattle-system --context $CONTEXT -o jsonpath='{range .items[?(@.type=="cluster.x-k8s.io/secret")]}{.metadata.name}{"\n"}{end}' 2>/dev/null
          echo ""
          echo "rancher CLI not found. Install: brew install rancher-cli"
          echo "Then run: rancher cluster kf $NAME"
        fi | less -K
  rancher-projects:
    shortCut: Shift-J
    override: true
    description: Projects & namespaces for cluster
    scopes:
      - clusters.management.cattle.io
      - projects.management.cattle.io
    command: bash
    background: false
    args:
      - -c
      - |
        echo "=== Projects for Cluster ==="
        kubectl get projects.management.cattle.io -A --context $CONTEXT -o custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,DISPLAY:.spec.displayName,CLUSTER:.spec.clusterName' 2>/dev/null | less -K
  rancher-fleet-overview:
    shortCut: Shift-F
    override: true
    description: Fleet status across clusters
    scopes:
      - clusters.fleet.cattle.io
      - gitrepos.fleet.cattle.io
      - bundles.fleet.cattle.io
      - bundledeployments.fleet.cattle.io
      - clustergroups.fleet.cattle.io
    command: bash
    background: false
    args:
      - -c
      - |
        echo "=== Fleet Status ==="
        echo ""
        echo "--- GitRepos ---"
        kubectl get gitrepos.fleet.cattle.io -A --context $CONTEXT -o wide 2>/dev/null
        echo ""
        echo "--- Fleet Clusters ---"
        kubectl get clusters.fleet.cattle.io -A --context $CONTEXT -o wide 2>/dev/null
        echo ""
        echo "--- Bundles ---"
        kubectl get bundles.fleet.cattle.io -A --context $CONTEXT -o custom-columns='NS:.metadata.namespace,NAME:.metadata.name,READY:.status.summary.ready,DESIRED:.status.summary.desiredReady' 2>/dev/null | less -K
