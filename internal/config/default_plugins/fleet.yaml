# Fleet plugins for rk9s
# Navigation: F3 for Fleet GitRepos view, Left/Right arrow to cycle CRDs
# Requires: fleet CLI (optional) or kubectl
plugins:
  # ─── gitrepos.fleet.cattle.io ────────────────────────────
  fleet-gitrepo-status:
    shortCut: Shift-G
    description: GitRepo status + resources + last update
    scopes:
      - gitrepos
      - gitrepos.fleet.cattle.io
    command: bash
    background: false
    inView: true
    args:
      - -c
      - |
        echo "=== Fleet GitRepo: $NAME ==="
        echo ""
        echo "--- Summary ---"
        kubectl get gitrepo -n $NAMESPACE $NAME --context $CONTEXT -o jsonpath='{
          "Repo:        "}{.spec.repo}{"
          "}{  "Branch:      "}{.spec.branch}{"
          "}{  "Paths:       "}{.spec.paths}{"
          "}{  "Targets:     "}{.spec.targets}{"
          "}{  "Ready:       "}{.status.summary.ready}{"/"}{.status.summary.desiredReady}{"
          "}{  "State:       "}{.status.display.state}{"
          "}{  "Message:     "}{.status.display.message}{"
          "}{  "Last Update: "}{.status.conditions[?(@.type=="Ready")].lastUpdateTime}{"
          "}' 2>/dev/null
        echo ""
        echo "--- Resources (count by kind) ---"
        kubectl get gitrepo -n $NAMESPACE $NAME --context $CONTEXT -o jsonpath='{range .status.resources[*]}{.kind}{"\n"}{end}' 2>/dev/null | sort | uniq -c | sort -rn || echo "  (no resources)"
        echo ""
        echo "--- Resources (detail) ---"
        kubectl get gitrepo -n $NAMESPACE $NAME --context $CONTEXT -o jsonpath='{range .status.resources[*]}  {.kind}/{.name} ({.state}){"\n"}{end}' 2>/dev/null
        echo ""
        echo "--- Conditions ---"
        kubectl get gitrepo -n $NAMESPACE $NAME --context $CONTEXT -o jsonpath='{range .status.conditions[*]}  {.type}: {.status} - {.message}{"\n"}{end}' 2>/dev/null
  fleet-gitrepo-reconcile:
    shortCut: Shift-R
    description: Force reconcile Fleet GitRepo
    scopes:
      - gitrepos.fleet.cattle.io
      - gitrepos
    command: bash
    background: false
    inView: true
    confirm: true
    args:
      - -c
      - |
        echo "Force reconciling $NAME..."
        kubectl annotate gitrepo -n $NAMESPACE $NAME fleet.cattle.io/force-reconcile=$(date +%s) --overwrite --context $CONTEXT
        echo ""
        echo "Reconciliation triggered. Checking status..."
        sleep 2
        kubectl get gitrepo -n $NAMESPACE $NAME --context $CONTEXT -o jsonpath='State: {.status.display.state}  Ready: {.status.summary.ready}/{.status.summary.desiredReady}'
        echo ""
  fleet-suspend:
    shortCut: Shift-S
    override: true
    description: Suspend GitRepo (pause delivery)
    scopes:
      - gitrepos.fleet.cattle.io
      - gitrepos
    command: bash
    background: false
    inView: true
    confirm: true
    args:
      - -c
      - |
        echo "Suspending GitRepo: $NAME"
        kubectl patch gitrepo -n $NAMESPACE $NAME --context $CONTEXT --type merge -p '{"spec":{"paused":true}}' 2>&1
        echo ""
        kubectl get gitrepo -n $NAMESPACE $NAME --context $CONTEXT -o jsonpath='Paused: {.spec.paused}' 2>/dev/null
        echo ""
  fleet-resume:
    shortCut: Shift-U
    override: true
    description: Resume GitRepo (unpause delivery)
    scopes:
      - gitrepos.fleet.cattle.io
      - gitrepos
    command: bash
    background: false
    inView: true
    confirm: true
    args:
      - -c
      - |
        echo "Resuming GitRepo: $NAME"
        kubectl patch gitrepo -n $NAMESPACE $NAME --context $CONTEXT --type merge -p '{"spec":{"paused":false}}' 2>&1
        echo ""
        kubectl get gitrepo -n $NAMESPACE $NAME --context $CONTEXT -o jsonpath='Paused: {.spec.paused}' 2>/dev/null
        echo ""
  fleet-drift-detect:
    shortCut: Shift-D
    override: true
    description: Drift detection (out-of-sync bundles)
    scopes:
      - gitrepos.fleet.cattle.io
      - gitrepos
      - bundles.fleet.cattle.io
    command: bash
    background: false
    inView: true
    args:
      - -c
      - |
        echo "=== Fleet Drift Detection ==="
        echo ""
        echo "--- Out-of-sync BundleDeployments ---"
        kubectl get bundledeployments.fleet.cattle.io -A --context $CONTEXT -o custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,STATE:.status.display.state,MESSAGE:.status.display.message' 2>/dev/null | grep -v -E '^NAMESPACE|Ready' || echo "  All bundle deployments are in sync!"
        echo ""
        echo "--- Bundles Not Fully Ready ---"
        kubectl get bundles.fleet.cattle.io -A --context $CONTEXT -o custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,READY:.status.summary.ready,DESIRED:.status.summary.desiredReady,NOT_READY:.status.summary.notReady,MODIFIED:.status.summary.modified' 2>/dev/null | awk 'NR==1{print; next} $3!=$4{print}' || echo "  All bundles fully ready!"
        echo ""
        echo "--- Modified Resources ---"
        kubectl get bundledeployments.fleet.cattle.io -A --context $CONTEXT -o jsonpath='{range .items[*]}{range .status.modifiedStatus[*]}  {.kind}/{.name} in {.namespace}: {.patch}{"\n"}{end}{end}' 2>/dev/null || echo "  (no modified resources)"
  fleet-agent-logs:
    shortCut: Shift-L
    override: true
    description: Fleet agent logs
    scopes:
      - gitrepos.fleet.cattle.io
      - gitrepos
      - clusters.fleet.cattle.io
      - bundles.fleet.cattle.io
    command: bash
    background: false
    inView: true
    args:
      - -c
      - |
        echo "=== Fleet Agent Logs ==="
        echo ""
        POD=$(kubectl get pods -n cattle-fleet-system --context $CONTEXT -l app=fleet-agent -o jsonpath='{.items[0].metadata.name}' 2>/dev/null)
        if [ -n "$POD" ]; then
          echo "Pod: $POD"
          echo ""
          kubectl logs -n cattle-fleet-system --context $CONTEXT $POD --tail=100 2>/dev/null
        else
          echo "Fleet agent pod not found in cattle-fleet-system namespace"
          echo "Trying cattle-fleet-local-system..."
          POD=$(kubectl get pods -n cattle-fleet-local-system --context $CONTEXT -l app=fleet-agent -o jsonpath='{.items[0].metadata.name}' 2>/dev/null)
          if [ -n "$POD" ]; then
            kubectl logs -n cattle-fleet-local-system --context $CONTEXT $POD --tail=100 2>/dev/null
          else
            echo "No fleet-agent pods found"
          fi
        fi
  fleet-target:
    shortCut: Shift-T
    description: Bundle targets (ready/modified/waiting)
    scopes:
      - bundles.fleet.cattle.io
      - bundledeployments.fleet.cattle.io
    command: bash
    background: false
    inView: true
    args:
      - -c
      - |
        echo "=== Bundle Targets: $NAME ==="
        echo ""
        if command -v fleet >/dev/null 2>&1; then
          fleet target $NAME --context $CONTEXT 2>/dev/null
        else
          echo "--- BundleDeployments ---"
          kubectl get bundledeployments.fleet.cattle.io -A --context $CONTEXT -l fleet.cattle.io/bundle-name=$NAME -o custom-columns='NS:.metadata.namespace,NAME:.metadata.name,STATE:.status.display.state,READY:.status.ready,MODIFIED:.status.modifiedStatus' 2>/dev/null
          echo ""
          echo "--- State Summary ---"
          kubectl get bundledeployments.fleet.cattle.io -A --context $CONTEXT -l fleet.cattle.io/bundle-name=$NAME -o custom-columns='STATE:.status.display.state' --no-headers 2>/dev/null | sort | uniq -c | sort -rn
        fi
  fleet-cluster-status:
    shortCut: Shift-C
    override: true
    description: Fleet cluster registration status
    scopes:
      - clusters.fleet.cattle.io
    command: bash
    background: false
    inView: true
    args:
      - -c
      - |
        echo "=== Fleet Cluster: $NAME ==="
        kubectl get clusters.fleet.cattle.io -n $NAMESPACE $NAME --context $CONTEXT -o jsonpath='{
          "Display Name:     "}{.spec.displayName}{"
          "}{  "Agent Namespace:  "}{.status.agent.namespace}{"
          "}{  "Ready:            "}{.status.display.readyBundles}{"
          "}{  "State:            "}{.status.display.state}{"
          "}' 2>/dev/null
        echo ""
        echo "--- Conditions ---"
        kubectl get clusters.fleet.cattle.io -n $NAMESPACE $NAME --context $CONTEXT -o jsonpath='{range .status.conditions[*]}  {.type}: {.status} ({.reason}){"\n"}{end}' 2>/dev/null
  fleet-overview:
    shortCut: Shift-I
    override: true
    description: Fleet overview dashboard
    scopes:
      - gitrepos.fleet.cattle.io
      - bundles.fleet.cattle.io
      - bundledeployments.fleet.cattle.io
      - clusters.fleet.cattle.io
      - clustergroups.fleet.cattle.io
    command: bash
    background: false
    inView: true
    args:
      - -c
      - |
        echo "=== Fleet Continuous Delivery Overview ==="
        echo ""
        if command -v fleet >/dev/null 2>&1; then
          echo "fleet CLI: $(fleet --version 2>/dev/null || echo 'unknown')"
          echo ""
        fi
        echo "--- GitRepos ---"
        kubectl get gitrepos.fleet.cattle.io -A --context $CONTEXT -o custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,REPO:.spec.repo,BRANCH:.spec.branch,READY:.status.summary.ready,DESIRED:.status.summary.desiredReady,STATE:.status.display.state,PAUSED:.spec.paused' 2>/dev/null
        echo ""
        echo "--- Fleet Clusters ---"
        kubectl get clusters.fleet.cattle.io -A --context $CONTEXT -o custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,READY:.status.display.readyBundles,STATE:.status.display.state' 2>/dev/null
        echo ""
        echo "--- Not Ready / Out-of-Sync ---"
        kubectl get bundledeployments.fleet.cattle.io -A --context $CONTEXT -o custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,STATE:.status.display.state' --no-headers 2>/dev/null | grep -v Ready || echo "  All deployments ready!"
        echo ""
        echo "--- Bundles (top 30) ---"
        kubectl get bundles.fleet.cattle.io -A --context $CONTEXT -o custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,READY:.status.summary.ready,DESIRED:.status.summary.desiredReady' 2>/dev/null | head -30
        echo ""
        echo "--- ClusterGroups ---"
        kubectl get clustergroups.fleet.cattle.io -A --context $CONTEXT -o wide 2>/dev/null || echo "  (no cluster groups)"
        echo ""
        echo "--- Fleet Agent ---"
        kubectl get pods -n cattle-fleet-system --context $CONTEXT -l app=fleet-agent -o custom-columns='NAME:.metadata.name,STATUS:.status.phase,RESTARTS:.status.containerStatuses[0].restartCount' 2>/dev/null || echo "  (fleet-agent not found)"   # ─── bundles.fleet.cattle.io ─────────────────────────────
  bundle-status:
    shortCut: Shift-O
    override: true
    description: Bundle status detail
    scopes:
      - bundles.fleet.cattle.io
    command: bash
    background: false
    inView: true
    args:
      - -c
      - |
        echo "=== Bundle: $NAME ==="
        kubectl get bundles.fleet.cattle.io -n $NAMESPACE $NAME --context $CONTEXT -o jsonpath='{
          "Ready:       "}{.status.summary.ready}{"/"}{.status.summary.desiredReady}{"
          "}{  "Not Ready:   "}{.status.summary.notReady}{"
          "}{  "Modified:    "}{.status.summary.modified}{"
          "}{  "Waiting:     "}{.status.summary.waiting}{"
          "}' 2>/dev/null
        echo ""
        echo "--- Conditions ---"
        kubectl get bundles.fleet.cattle.io -n $NAMESPACE $NAME --context $CONTEXT -o jsonpath='{range .status.conditions[*]}  {.type}: {.status} ({.message}){"\n"}{end}' 2>/dev/null   # ─── bundledeployments.fleet.cattle.io ───────────────────
  bundledeployment-status:
    shortCut: Shift-O
    override: true
    description: BundleDeployment detail
    scopes:
      - bundledeployments.fleet.cattle.io
    command: bash
    background: false
    inView: true
    args:
      - -c
      - |
        echo "=== BundleDeployment: $NAME ==="
        kubectl get bundledeployments.fleet.cattle.io -n $NAMESPACE $NAME --context $CONTEXT -o jsonpath='{
          "State:   "}{.status.display.state}{"
          "}{  "Ready:   "}{.status.ready}{"
          "}{  "Message: "}{.status.display.message}{"
          "}' 2>/dev/null
        echo ""
        echo "--- Modified Resources ---"
        kubectl get bundledeployments.fleet.cattle.io -n $NAMESPACE $NAME --context $CONTEXT -o jsonpath='{range .status.modifiedStatus[*]}  {.kind}/{.name}: {.patch}{"\n"}{end}' 2>/dev/null || echo "  (none)"
        echo ""
        echo "--- Non-Ready Resources ---"
        kubectl get bundledeployments.fleet.cattle.io -n $NAMESPACE $NAME --context $CONTEXT -o jsonpath='{range .status.nonReadyStatus[*]}  {.kind}/{.name}: {.message}{"\n"}{end}' 2>/dev/null || echo "  (none)"
  bundledeployment-redeploy:
    shortCut: Shift-R
    override: true
    description: Force redeploy
    scopes:
      - bundledeployments.fleet.cattle.io
    command: bash
    background: false
    inView: true
    confirm: true
    args:
      - -c
      - |
        echo "Force redeploying $NAME..."
        kubectl annotate bundledeployment -n $NAMESPACE $NAME fleet.cattle.io/force-reconcile=$(date +%s) --overwrite --context $CONTEXT
        echo "Redeploy triggered."
