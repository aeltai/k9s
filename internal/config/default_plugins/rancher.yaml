# Rancher plugins for rk9s
# Uses KUBECONFIG + API tokens from active context
# For Rancher management API: use context pointing at Rancher server (API token in kubeconfig)
plugins:
  rancher-open-ui:
    shortCut: Shift-O
    description: Open Rancher UI in browser
    scopes:
      - all
    command: bash
    background: true
    args:
      - -c
      - |
        server=$(kubectl config view --context $CONTEXT --minify -o jsonpath='{.clusters[0].cluster.server}' 2>/dev/null | sed 's|https://api\.||' | sed 's|:6443||')
        if [ -n "$server" ]; then
          open "https://${server}/dashboard" 2>/dev/null || xdg-open "https://${server}/dashboard" 2>/dev/null || echo "Rancher server: https://${server}/dashboard"
        else
          echo "Could not determine Rancher server URL. Set RANCHER_SERVER or check kubeconfig."
        fi
  rancher-fleet-ui:
    shortCut: Shift-F
    description: Open Fleet UI in browser
    scopes:
      - all
    command: bash
    background: true
    args:
      - -c
      - |
        server=$(kubectl config view --context $CONTEXT --minify -o jsonpath='{.clusters[0].cluster.server}' 2>/dev/null | sed 's|https://api\.||' | sed 's|:6443||')
        if [ -n "$server" ]; then
          open "https://${server}/dashboard/c/_/fleet" 2>/dev/null || xdg-open "https://${server}/dashboard/c/_/fleet" 2>/dev/null || echo "Fleet UI: https://${server}/dashboard/c/_/fleet"
        else
          echo "Could not determine Rancher server URL."
        fi
  rancher-sync-kubeconfig:
    shortCut: Shift-K
    description: Sync kubeconfig from Rancher
    scopes:
      - all
    command: rancher
    background: false
    confirm: false
    args:
      - context
      - switch
      - $CONTEXT
  rancher-projects:
    shortCut: Shift-J
    description: List Rancher projects (management API)
    scopes:
      - all
    command: kubectl
    background: false
    args:
      - get
      - projects.management.cattle.io
      - -A
      - --context
      - $CONTEXT
  rancher-clusters:
    shortCut: Shift-U
    description: List Rancher clusters (rancher CLI or kubectl)
    scopes:
      - all
    command: bash
    background: false
    args:
      - -c
      - |
        if command -v rancher >/dev/null 2>&1; then
          rancher cluster ls 2>/dev/null || kubectl get clusters.management.cattle.io -A --context $CONTEXT 2>/dev/null | less -K
        else
          kubectl get clusters.management.cattle.io -A --context $CONTEXT 2>/dev/null | less -K
        fi
  rancher-multi-context:
    shortCut: Shift-M
    description: Run across selected contexts (use $CONTEXTS)
    scopes:
      - contexts
    command: bash
    background: false
    args:
      - -c
      - |
        if [ -z "${CONTEXTS:-}" ]; then
          echo "Select contexts first: Space=toggle, Ctrl-A=all, Ctrl-Space=none"
          exit 1
        fi
        echo "=== Running across contexts: $CONTEXTS ==="
        for ctx in $(echo "$CONTEXTS" | tr ',' ' '); do
          echo ""; echo "--- $ctx ---"; kubectl get nodes --context "$ctx" 2>/dev/null || true
        done
        echo ""; echo "Done. Use Shift-M in context view after selecting contexts."
