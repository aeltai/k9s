# RKE2 / K3s node plugins for rk9s
# Node scope: $NAME is the node name
# These plugins use kubectl debug for node access
# Navigation: Use Shift-5 for Nodes dashboard
plugins:
  rke2-k3s-config:
    shortCut: Shift-C
    description: RKE2/K3s config + args + TLS-SAN + CNI
    scopes:
      - node
      - nodes
    command: bash
    background: false
    args:
      - -c
      - |
        echo "=== Node Configuration: $NAME ==="
        echo ""
        kubectl debug node/$NAME --context $CONTEXT -it --image=alpine:3.18 -- chroot /host sh -c '
          echo "--- Distro Detection ---"
          if [ -f /etc/rancher/rke2/config.yaml ]; then
            echo "Distro: RKE2"
            echo ""
            echo "--- /etc/rancher/rke2/config.yaml ---"
            cat /etc/rancher/rke2/config.yaml
            echo ""
            echo "--- RKE2 Version ---"
            rke2 --version 2>/dev/null || echo "(cannot detect version)"
            echo ""
            echo "--- Server/Agent Args ---"
            cat /etc/rancher/rke2/rke2-server.env 2>/dev/null || echo "(no server env)"
            cat /etc/rancher/rke2/rke2-agent.env 2>/dev/null || echo "(no agent env)"
            echo ""
            echo "--- TLS SAN ---"
            grep -i tls-san /etc/rancher/rke2/config.yaml 2>/dev/null || echo "(no tls-san configured)"
            echo ""
            echo "--- CNI Config ---"
            ls /etc/cni/net.d/ 2>/dev/null && cat /etc/cni/net.d/*.conflist 2>/dev/null | head -30 || echo "(no CNI config)"
            echo ""
            echo "--- Token Hash ---"
            sha256sum /etc/rancher/rke2/token 2>/dev/null | cut -d" " -f1 || echo "(no token file)"
          elif [ -f /etc/rancher/k3s/config.yaml ]; then
            echo "Distro: K3s"
            echo ""
            echo "--- /etc/rancher/k3s/config.yaml ---"
            cat /etc/rancher/k3s/config.yaml
            echo ""
            echo "--- K3s Version ---"
            k3s --version 2>/dev/null || echo "(cannot detect version)"
            echo ""
            echo "--- Server/Agent Args ---"
            cat /etc/systemd/system/k3s.service.env 2>/dev/null || echo "(no service env)"
            echo ""
            echo "--- TLS SAN ---"
            grep -i tls-san /etc/rancher/k3s/config.yaml 2>/dev/null || echo "(no tls-san configured)"
            echo ""
            echo "--- CNI Config ---"
            ls /var/lib/rancher/k3s/agent/etc/cni/net.d/ 2>/dev/null && cat /var/lib/rancher/k3s/agent/etc/cni/net.d/*.conflist 2>/dev/null | head -30 || echo "(no CNI config)"
          else
            echo "No RKE2 or K3s config found on this node"
            echo ""
            echo "Checking kubelet args..."
            cat /var/lib/kubelet/kubeadm-flags.env 2>/dev/null || echo "(not a kubeadm node either)"
          fi
        ' 2>/dev/null | less -K
  node-distro-services:
    shortCut: Shift-D
    description: Node services + journal errors + containerd
    scopes:
      - node
      - nodes
    command: bash
    background: false
    args:
      - -c
      - |
        echo "=== Service Status: $NAME ==="
        echo ""
        kubectl debug node/$NAME --context $CONTEXT -it --image=alpine:3.18 -- chroot /host sh -c '
          echo "--- Service Status ---"
          for svc in rke2-server rke2-agent k3s containerd kubelet; do
            status=$(systemctl is-active $svc 2>/dev/null)
            if [ "$status" != "unknown" ] 2>/dev/null; then
              printf "  %-20s %s\n" "$svc" "$status"
            fi
          done
          echo ""
          echo "--- Containerd Version ---"
          containerd --version 2>/dev/null || /var/lib/rancher/rke2/bin/containerd --version 2>/dev/null || echo "  (containerd not found in PATH)"
          echo ""
          echo "--- Failed Services ---"
          systemctl --failed --no-pager 2>/dev/null | head -20
          echo ""
          echo "--- Recent Journal Errors (last 20) ---"
          journalctl -p err --no-pager -n 20 2>/dev/null || echo "  (journalctl not available)"
          echo ""
          echo "--- Disk Usage ---"
          df -h / /var/lib/rancher 2>/dev/null
          echo ""
          echo "--- Memory ---"
          free -h 2>/dev/null
          echo ""
          echo "--- Uptime ---"
          uptime 2>/dev/null
        ' 2>/dev/null | less -K
  crictl-ps:
    shortCut: Shift-P
    description: crictl ps â€“ containers sorted by memory
    scopes:
      - node
      - nodes
    command: bash
    background: false
    args:
      - -c
      - |
        echo "=== Containers on Node: $NAME ==="
        echo ""
        kubectl debug node/$NAME --context $CONTEXT -it --image=alpine:3.18 -- chroot /host sh -c '
          echo "--- Running Containers ---"
          crictl ps --output table 2>/dev/null || echo "crictl not available"
          echo ""
          echo "--- Container Resource Usage (sorted by memory) ---"
          crictl stats --output table 2>/dev/null | head -1
          crictl stats --output table 2>/dev/null | tail -n +2 | sort -k4 -h -r | head -30
          echo ""
          echo "--- Images (top 20 by size) ---"
          crictl images --output table 2>/dev/null | head -1
          crictl images --output table 2>/dev/null | tail -n +2 | sort -k4 -h -r | head -20
        ' 2>/dev/null | less -K
  etcdctl-health:
    shortCut: Shift-E
    description: etcdctl health + db size + alarms
    scopes:
      - node
      - nodes
    command: bash
    background: false
    args:
      - -c
      - |
        echo "=== etcd Health: $NAME ==="
        echo ""
        kubectl debug node/$NAME --context $CONTEXT -it --image=alpine:3.18 -- chroot /host sh -c '
          export ETCDCTL_ENDPOINTS=https://127.0.0.1:2379
          export ETCDCTL_CACERT=/var/lib/rancher/rke2/server/tls/etcd/server-ca.crt
          export ETCDCTL_CERT=/var/lib/rancher/rke2/server/tls/etcd/server-client.crt
          export ETCDCTL_KEY=/var/lib/rancher/rke2/server/tls/etcd/server-client.key
          if [ ! -f "$ETCDCTL_CACERT" ]; then
            export ETCDCTL_CACERT=/etc/kubernetes/pki/etcd/ca.crt
            export ETCDCTL_CERT=/etc/kubernetes/pki/etcd/server.crt
            export ETCDCTL_KEY=/etc/kubernetes/pki/etcd/server.key
          fi
          echo "--- Endpoint Health ---"
          etcdctl endpoint health 2>/dev/null || echo "etcdctl not found or certs not available (this may not be a control-plane node)"
          echo ""
          echo "--- Endpoint Status (incl. DB size) ---"
          etcdctl endpoint status --write-out=table 2>/dev/null
          echo ""
          echo "--- Member List ---"
          etcdctl member list --write-out=table 2>/dev/null
          echo ""
          echo "--- Alarms ---"
          ALARMS=$(etcdctl alarm list 2>/dev/null)
          if [ -z "$ALARMS" ]; then
            echo "  No alarms active"
          else
            echo "$ALARMS"
          fi
          echo ""
          echo "--- Defrag Status ---"
          etcdctl endpoint status --write-out=json 2>/dev/null | python3 -c "
          import sys, json
          try:
            data = json.load(sys.stdin)
            for ep in data:
              db = ep.get(\"Status\",{}).get(\"dbSize\",0)
              inuse = ep.get(\"Status\",{}).get(\"dbSizeInUse\",0)
              frag = ((db - inuse) / db * 100) if db > 0 else 0
              print(f\"  DB: {db/1024/1024:.1f}MB  InUse: {inuse/1024/1024:.1f}MB  Fragmentation: {frag:.1f}%\")
          except: print(\"  (unable to parse status)\")
          " 2>/dev/null || echo "  (defrag check unavailable)"
        ' 2>/dev/null | less -K
  longhorn-node-storage:
    shortCut: Shift-G
    override: true
    description: Longhorn node storage info
    scopes:
      - node
      - nodes
    command: bash
    background: false
    args:
      - -c
      - |
        echo "=== Longhorn Storage on Node: $NAME ==="
        echo ""
        echo "--- Longhorn Node ---"
        kubectl get nodes.longhorn.io -n longhorn-system $NAME --context $CONTEXT -o jsonpath='{
          "Ready:         "}{.status.conditions.Ready.status}{"
          "}{  "Schedulable:   "}{.spec.allowScheduling}{"
          "}{  "Region:        "}{.status.region}{"
          "}{  "Zone:          "}{.status.zone}{"
          "}' 2>/dev/null || echo "  (Longhorn not installed or node not registered)"
        echo ""
        echo "--- Disk Status ---"
        kubectl get nodes.longhorn.io -n longhorn-system $NAME --context $CONTEXT -o jsonpath='{range .status.diskStatus.*}  Disk: {.diskUUID}  Schedulable: {.conditions.Schedulable.status}  Storage: {.storageAvailable}/{.storageMaximum}{"\n"}{end}' 2>/dev/null
        echo ""
        echo "--- Scheduled Volumes on This Node ---"
        kubectl get volumes.longhorn.io -n longhorn-system --context $CONTEXT -o custom-columns='NAME:.metadata.name,STATE:.status.state,NODE:.status.currentNodeID,SIZE:.spec.size' 2>/dev/null | grep -E "NAME|$NAME" || echo "  (no volumes on this node)"
        echo ""
        echo "--- Replicas on This Node ---"
        kubectl get replicas.longhorn.io -n longhorn-system --context $CONTEXT -o custom-columns='NAME:.metadata.name,VOLUME:.spec.volumeName,STATE:.status.currentState' 2>/dev/null | grep -E "NAME|$NAME" | head -20 || echo "  (no replicas)" | less -K
  etcd-snapshot:
    shortCut: Shift-N
    description: etcd snapshot save
    scopes:
      - node
      - nodes
    command: bash
    background: false
    args:
      - -c
      - |
        echo "=== etcd Snapshot: $NAME ==="
        echo ""
        kubectl debug node/$NAME --context $CONTEXT -it --image=alpine:3.18 -- chroot /host sh -c '
          export ETCDCTL_ENDPOINTS=https://127.0.0.1:2379
          for d in /var/lib/rancher/rke2/server/tls/etcd /var/lib/rancher/k3s/server/tls/etcd /etc/kubernetes/pki/etcd; do
            if [ -f "$d/server-ca.crt" ] || [ -f "$d/ca.crt" ]; then
              export ETCDCTL_CACERT=$(ls "$d"/server-ca.crt "$d"/ca.crt 2>/dev/null | head -1)
              export ETCDCTL_CERT=$(ls "$d"/server-client.crt "$d"/server.crt 2>/dev/null | head -1)
              export ETCDCTL_KEY=$(ls "$d"/server-client.key "$d"/server.key 2>/dev/null | head -1)
              break
            fi
          done
          TS=$(date +%Y%m%d-%H%M%S)
          SNAP="/tmp/etcd-snapshot-${TS}.db"
          echo "Saving snapshot to $SNAP ..."
          etcdctl snapshot save "$SNAP" 2>&1
          echo ""
          echo "--- Snapshot Status ---"
          etcdctl snapshot status "$SNAP" --write-out=table 2>&1
          echo ""
          echo "Snapshot saved at: $SNAP (inside debug container)"
          echo "To copy out, use: kubectl cp ..."
        ' 2>/dev/null | less -K
  etcd-defrag:
    shortCut: Shift-F
    override: true
    description: etcd defragment
    scopes:
      - node
      - nodes
    command: bash
    background: false
    args:
      - -c
      - |
        echo "=== etcd Defrag: $NAME ==="
        echo ""
        echo "WARNING: Defragmentation causes a brief pause in etcd."
        echo ""
        kubectl debug node/$NAME --context $CONTEXT -it --image=alpine:3.18 -- chroot /host sh -c '
          export ETCDCTL_ENDPOINTS=https://127.0.0.1:2379
          for d in /var/lib/rancher/rke2/server/tls/etcd /var/lib/rancher/k3s/server/tls/etcd /etc/kubernetes/pki/etcd; do
            if [ -f "$d/server-ca.crt" ] || [ -f "$d/ca.crt" ]; then
              export ETCDCTL_CACERT=$(ls "$d"/server-ca.crt "$d"/ca.crt 2>/dev/null | head -1)
              export ETCDCTL_CERT=$(ls "$d"/server-client.crt "$d"/server.crt 2>/dev/null | head -1)
              export ETCDCTL_KEY=$(ls "$d"/server-client.key "$d"/server.key 2>/dev/null | head -1)
              break
            fi
          done
          echo "--- Before Defrag ---"
          etcdctl endpoint status --write-out=table 2>&1
          echo ""
          echo "Running defrag..."
          etcdctl defrag 2>&1
          echo ""
          echo "--- After Defrag ---"
          etcdctl endpoint status --write-out=table 2>&1
        ' 2>/dev/null | less -K
  etcd-alarm-disarm:
    shortCut: Shift-A
    override: true
    description: etcd alarm disarm
    scopes:
      - node
      - nodes
    command: bash
    background: false
    args:
      - -c
      - |
        echo "=== etcd Alarm Disarm: $NAME ==="
        echo ""
        kubectl debug node/$NAME --context $CONTEXT -it --image=alpine:3.18 -- chroot /host sh -c '
          export ETCDCTL_ENDPOINTS=https://127.0.0.1:2379
          for d in /var/lib/rancher/rke2/server/tls/etcd /var/lib/rancher/k3s/server/tls/etcd /etc/kubernetes/pki/etcd; do
            if [ -f "$d/server-ca.crt" ] || [ -f "$d/ca.crt" ]; then
              export ETCDCTL_CACERT=$(ls "$d"/server-ca.crt "$d"/ca.crt 2>/dev/null | head -1)
              export ETCDCTL_CERT=$(ls "$d"/server-client.crt "$d"/server.crt 2>/dev/null | head -1)
              export ETCDCTL_KEY=$(ls "$d"/server-client.key "$d"/server.key 2>/dev/null | head -1)
              break
            fi
          done
          echo "--- Current Alarms ---"
          ALARMS=$(etcdctl alarm list 2>&1)
          if [ -z "$ALARMS" ]; then
            echo "  No alarms active. Nothing to disarm."
          else
            echo "$ALARMS"
            echo ""
            echo "Disarming all alarms..."
            etcdctl alarm disarm 2>&1
            echo ""
            echo "--- Alarms After Disarm ---"
            etcdctl alarm list 2>&1 || echo "  No alarms"
          fi
        ' 2>/dev/null | less -K
