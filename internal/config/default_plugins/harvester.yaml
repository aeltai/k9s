# Harvester / KubeVirt VM overview plugins for rk9s
# VM lifecycle commands (console, vnc, start, stop, etc.) are in virtctl.yaml
# Navigation: F5 for KubeVirt VMs view
plugins:
  harvester-vm-overview:
    shortCut: Shift-H
    description: VM overview (status, IPs, resources)
    scopes:
      - virtualmachines.kubevirt.io
    command: bash
    background: false
    inView: true
    args:
      - -c
      - |
        echo "=== VM Overview: $NAME ==="
        echo ""
        echo "--- VM Status ---"
        kubectl get vm $NAME -n $NAMESPACE --context $CONTEXT -o wide 2>/dev/null
        echo ""
        echo "--- VMI (running instance) ---"
        kubectl get vmi $NAME -n $NAMESPACE --context $CONTEXT -o wide 2>/dev/null
        echo ""
        echo "--- Disks & Volumes ---"
        kubectl get vm $NAME -n $NAMESPACE --context $CONTEXT -o jsonpath='{range .spec.template.spec.volumes[*]}{.name}{"\t"}{.persistentVolumeClaim.claimName}{"\t"}{.containerDisk.image}{"\t"}{.cloudInitNoCloud.userData}{"\n"}{end}' 2>/dev/null
        echo ""
        echo "--- Network Interfaces ---"
        kubectl get vmi $NAME -n $NAMESPACE --context $CONTEXT -o jsonpath='{range .status.interfaces[*]}Name: {.name}  IP: {.ipAddress}  MAC: {.mac}{"\n"}{end}' 2>/dev/null
        echo ""
        echo "Press q to return"
  harvester-vm-events:
    shortCut: Shift-E
    override: true
    description: VM events & conditions
    scopes:
      - virtualmachines.kubevirt.io
      - virtualmachineinstances.kubevirt.io
    command: bash
    background: false
    inView: true
    args:
      - -c
      - |
        echo "=== Events for VM: $NAME ==="
        kubectl get events -n $NAMESPACE --context $CONTEXT --field-selector involvedObject.name=$NAME --sort-by='.lastTimestamp' 2>/dev/null
        echo ""
        echo "=== Conditions ==="
        kubectl get vm $NAME -n $NAMESPACE --context $CONTEXT -o jsonpath='{range .status.conditions[*]}Type: {.type}  Status: {.status}  Reason: {.reason}  Message: {.message}{"\n"}{end}' 2>/dev/null
  harvester-overview:
    shortCut: Shift-O
    override: true
    description: Harvester / KubeVirt overview
    scopes:
      - virtualmachines.kubevirt.io
      - virtualmachineinstances.kubevirt.io
    command: bash
    background: false
    inView: true
    args:
      - -c
      - |
        echo "=== Harvester / KubeVirt Overview ==="
        echo ""
        echo "--- Virtual Machines ---"
        kubectl get vm -A --context $CONTEXT -o custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,RUNNING:.spec.running,AGE:.metadata.creationTimestamp' 2>/dev/null || echo "  (no VMs found)"
        echo ""
        echo "--- VM Instances (running) ---"
        kubectl get vmi -A --context $CONTEXT -o custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,PHASE:.status.phase,NODE:.status.nodeName,IP:.status.interfaces[0].ipAddress' 2>/dev/null || echo "  (no running VMIs)"
        echo ""
        echo "--- DataVolumes ---"
        kubectl get dv -A --context $CONTEXT -o custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,PHASE:.status.phase,PROGRESS:.status.progress' 2>/dev/null || echo "  (no data volumes)"
        echo ""
        echo "--- VM Migrations ---"
        kubectl get vmim -A --context $CONTEXT -o custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,PHASE:.status.phase' 2>/dev/null || echo "  (no migrations)"
        echo ""
        echo "--- VM Networks ---"
        kubectl get net-attach-def -A --context $CONTEXT -o custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name' 2>/dev/null || echo "  (no network attachments)"   # ─── VMI scope ───────────────────────────────────────────
  vmi-detail:
    shortCut: Shift-O
    override: true
    description: VMI detail (node, IP, phase)
    scopes:
      - virtualmachineinstances.kubevirt.io
    command: bash
    background: false
    inView: true
    args:
      - -c
      - |
        echo "=== VMI: $NAME ==="
        kubectl get vmi $NAME -n $NAMESPACE --context $CONTEXT -o jsonpath='{
          "Phase: "}{.status.phase}{"\n"}{
          "Node:  "}{.status.nodeName}{"\n"}{
          "IPs:   "}{range .status.interfaces[*]}{.ipAddress}{" "}{end}{"\n"}{
          }' 2>/dev/null   # ─── DataVolume scope ────────────────────────────────────
  dv-detail:
    shortCut: Shift-O
    override: true
    description: DataVolume detail
    scopes:
      - datavolumes.cdi.kubevirt.io
    command: bash
    background: false
    inView: true
    args:
      - -c
      - |
        echo "=== DataVolume: $NAME ==="
        kubectl get dv $NAME -n $NAMESPACE --context $CONTEXT -o jsonpath='{
          "Phase:    "}{.status.phase}{"\n"}{
          "Progress: "}{.status.progress}{"\n"}{
          "Source:   "}{.spec.source}{"\n"}{
          }' 2>/dev/null 