# Longhorn CLI (longhornctl) plugins for rk9s
# Requires: longhornctl (https://github.com/longhorn/cli/releases)
# Navigation: Use Shift-1 to jump to Longhorn Volumes, Shift-2 for Longhorn Nodes
plugins:
  longhorn-check:
    shortCut: Shift-L
    description: Longhorn preflight check (longhornctl)
    scopes:
      - volumes.longhorn.io
    command: bash
    background: false
    args:
      - -c
      - |
        if command -v longhornctl >/dev/null 2>&1; then
          echo "=== Longhorn Environment Check ==="
          longhornctl --kubeconfig $KUBECONFIG check preflight 2>&1 | less -K
        else
          echo "longhornctl not installed. Showing volume status via kubectl..."
          echo ""
          kubectl get volumes.longhorn.io -n longhorn-system --context $CONTEXT -o wide 2>&1 | less -K
        fi
  longhorn-trim-volume:
    shortCut: Shift-T
    description: Trim Longhorn volume (reclaim space)
    scopes:
      - volumes.longhorn.io
    command: bash
    background: false
    confirm: true
    args:
      - -c
      - |
        if command -v longhornctl >/dev/null 2>&1; then
          longhornctl --kubeconfig $KUBECONFIG trim volume $NAME
        else
          echo "longhornctl not installed. Cannot trim volume."
          echo "Install: https://github.com/longhorn/cli/releases"
        fi
  longhorn-get-replica:
    shortCut: Shift-R
    description: Longhorn replica info for volume
    scopes:
      - volumes.longhorn.io
    command: bash
    background: false
    args:
      - -c
      - |
        echo "=== Volume: $NAME ==="
        echo "--- Replicas ---"
        kubectl get replicas.longhorn.io -n longhorn-system --context $CONTEXT -l longhornvolume=$NAME -o wide 2>/dev/null
        echo ""
        echo "--- Engines ---"
        kubectl get engines.longhorn.io -n longhorn-system --context $CONTEXT -l longhornvolume=$NAME -o wide 2>/dev/null | less -K
  longhorn-volume-yaml:
    shortCut: Shift-S
    override: true
    description: Longhorn Volume YAML + replicas
    scopes:
      - volumes.longhorn.io
    command: bash
    background: false
    args:
      - -c
      - kubectl get volume -n longhorn-system $NAME -o yaml --context $CONTEXT | less -K
  longhorn-snapshots:
    shortCut: Shift-B
    description: Longhorn snapshots for volume
    scopes:
      - volumes.longhorn.io
    command: bash
    background: false
    args:
      - -c
      - |
        if command -v longhornctl >/dev/null 2>&1; then
          longhornctl --kubeconfig $KUBECONFIG snapshot list $NAME 2>/dev/null | less -K
        else
          echo "longhornctl not installed. Showing volume snapshot info..."
          kubectl get snapshots.longhorn.io -n longhorn-system --context $CONTEXT -l longhornvolume=$NAME -o wide 2>/dev/null | less -K
        fi
  longhorn-node-info:
    shortCut: Shift-G
    description: Longhorn node info (longhornctl)
    scopes:
      - nodes
      - node
    command: bash
    background: false
    args:
      - -c
      - |
        if command -v longhornctl >/dev/null 2>&1; then
          longhornctl --kubeconfig $KUBECONFIG node get $NAME 2>/dev/null | less -K
        else
          kubectl get node $NAME -o yaml --context $CONTEXT | less -K
        fi
  longhorn-overview:
    shortCut: Shift-I
    override: true
    description: Longhorn overview dashboard
    scopes:
      - volumes.longhorn.io
      - nodes.longhorn.io
      - engineimages.longhorn.io
      - replicas.longhorn.io
      - settings.longhorn.io
    command: bash
    background: false
    args:
      - -c
      - |
        echo "=== Longhorn Storage Overview ==="
        echo ""
        echo "--- Volumes ---"
        kubectl get volumes.longhorn.io -n longhorn-system --context $CONTEXT -o custom-columns='NAME:.metadata.name,STATE:.status.state,ROBUSTNESS:.status.robustness,SIZE:.spec.size,REPLICAS:.spec.numberOfReplicas,NODE:.status.currentNodeID' 2>/dev/null || echo "  (no volumes)"
        echo ""
        echo "--- Nodes ---"
        kubectl get nodes.longhorn.io -n longhorn-system --context $CONTEXT -o custom-columns='NAME:.metadata.name,READY:.status.conditions.Ready.status,SCHEDULABLE:.spec.allowScheduling' 2>/dev/null || echo "  (no nodes)"
        echo ""
        echo "--- Engine Images ---"
        kubectl get engineimages.longhorn.io -n longhorn-system --context $CONTEXT -o wide 2>/dev/null || echo "  (no engine images)"
        echo ""
        echo "--- Replicas (top 30) ---"
        kubectl get replicas.longhorn.io -n longhorn-system --context $CONTEXT -o custom-columns='NAME:.metadata.name,VOLUME:.spec.volumeName,NODE:.spec.nodeID,STATE:.status.currentState' 2>/dev/null | head -30
        echo ""
        echo "--- Settings (top 20) ---"
        kubectl get settings.longhorn.io -n longhorn-system --context $CONTEXT -o custom-columns='NAME:.metadata.name,VALUE:.value' 2>/dev/null | head -20 | less -K
